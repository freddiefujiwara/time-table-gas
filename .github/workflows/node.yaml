name: Node CI

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - node-version: "18"
            deploy: false
          - node-version: "20"
            deploy: false
          - node-version: "22"
            deploy: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "${{ matrix.node-version }}"

      - name: Install deps
        run: npm install

      - name: Run tests
        run: npm test

      - name: Build
        if: ${{ matrix.deploy }}
        run: npm run build

      - name: Install clasp
        if: ${{ matrix.deploy }}
        run: npm i -g @google/clasp

      - name: Write clasp credentials
        if: ${{ matrix.deploy }}
        run: |
          echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json

      - name: Push dist to Apps Script
        if: ${{ matrix.deploy }}
        run: clasp push --force

      - name: Create version
        if: ${{ matrix.deploy }}
        id: version
        run: |
          OUT=$(clasp create-version "Auto deploy from Node CI")
          VER=$(echo "$OUT" | grep -Eo '[0-9]+' | tail -1)
          echo "ver=$VER" >> $GITHUB_OUTPUT

      - name: Deploy
        if: ${{ matrix.deploy }}
        run: |
          if [ -n "${{ secrets.DEPLOYMENT_ID }}" ]; then
            clasp update-deployment \
              "${{ secrets.DEPLOYMENT_ID }}" \
              -V "${{ steps.version.outputs.ver }}" \
              -d "Auto deploy from Node CI"
          else
            clasp create-deployment \
              -V "${{ steps.version.outputs.ver }}" \
              -d "Auto deploy from Node CI"
          fi
